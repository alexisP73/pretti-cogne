name: K8s Lint

on:
  push:
    branches: [master]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Validate dev overlay
        run: kustomize build overlays/dev
      - name: Validate prod overlay
        run: kustomize build overlays/prod

      # Security Check 1: vuln dans images Docker
      - name: Trivy scan Docker images
        run: |
          # Scanner nginx:1.23 utilis√© dans le deployment
          docker pull nginx:1.23
          trivy image --exit-code 1 --severity HIGH,CRITICAL nginx:1.23

      # Security Check 2: secrets leak
      - name: Scan repo for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          directory: .
          github_token: ${{ secrets.GITHUB_TOKEN }}

