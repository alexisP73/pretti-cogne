name: K8s Lint + Security Checks

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # pour que TruffleHog scanne tout l'historique

      # 2️⃣ Lint Kustomize overlays dev/prod
      - name: Validate dev overlay
        run: kustomize build overlays/dev

      - name: Validate prod overlay
        run: kustomize build overlays/prod

      # 3️⃣ Installer Trivy correctement
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh
          sudo mv trivy /usr/local/bin/   # Important : ajoute Trivy au PATH
          trivy --version

      # 4️⃣ Pull et scanner l'image Docker
      - name: Trivy scan Docker image
        run: |
          docker pull nginx:1.23
          trivy image --exit-code 1 --severity HIGH,CRITICAL nginx:1.23

      # 5️⃣ Scanner les secrets du repo avec TruffleHog
      - name: Scan repo for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: .
          github_token: ${{ secrets.GITHUB_TOKEN }}

